
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>自动化部署工具 Ansible填坑记录 - AIX Zing</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="&lt;br/&gt;光荣在于平淡&lt;br/&gt;艰巨在于漫长&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;无论我多早迎接这清晨&lt;br/&gt;在路上&lt;br/&gt;都会有人在&lt;br/&gt;我以为别人还在梦乡&lt;br/&gt;但无论什么时候&lt;br/&gt;这个世界都比我快一步,因为公司想对项目逐步转向为自动化部署，所以安排我和一位大佬做起了运维。目前是想先用ansible实现从git上获取code，在ansible主机上编译，配置，打包，发布。所以就有了这篇文章。

0x,"> 
    <meta name="author" content="zing"> 
    <link rel="alternative" href="atom.xml" title="AIX Zing" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.ico"> 
    
    <link rel="stylesheet" href="/css/diaspora.css">
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
</head>
</html>
<body class="loading">
    <span id="config-title" style="display:none">AIX Zing</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://xzing.github.io"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">自动化部署工具 Ansible填坑记录</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class="main">
        <h1 class="title">自动化部署工具 Ansible填坑记录</h1>
        <div class="stuff">
            <span>五月 31, 2017</span>
            
  <ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Linux/">Linux</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/ansible/">ansible</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/自动化持续部署/">自动化持续部署</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/运维/">运维</a></li></ul>


        </div>
        <div class="content markdown">
            <p>因为公司想对项目逐步转向为自动化部署，所以安排我和一位大佬做起了运维。目前是想先用ansible实现从git上获取code，在ansible主机上编译，配置，打包，发布。所以就有了这篇文章。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1112615-fea8ebad97cb96d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><a id="more"></a></p>
<h1 id="0x00-安装"><a href="#0x00-安装" class="headerlink" title="0x00 安装"></a>0x00 安装</h1><p>Ubuntu 16.04<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install software-properties-common</span><br><span class="line">sudo apt-add-repository ppa:ansible/ansible</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ansible</span><br></pre></td></tr></table></figure></p>
<p>Pip安装<br>pip是Python的包管理工具，先装好pip，再安装ansible。目前建议Python版本：2.7，pip版本：9<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install ansible</span><br></pre></td></tr></table></figure></p>
<p>源码编译安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git://github.com/ansible/ansible.git --recursive</span><br><span class="line"><span class="built_in">cd</span> ./ansible</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<p>CentOS安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install ansible</span><br></pre></td></tr></table></figure></p>
<blockquote>
</blockquote>
<ul>
<li>强烈建议使用CentOS安装。且安装ansible用户最好能保证拥有其他需要使用软件的权限，如Maven，Java，Python，Mysql等<br>否则ansible使用到这些软件时，容易出现权限不足，或者找不到环境变量等问题</li>
<li>Windows server 和OS X最好放在虚拟机里学习ansible，因为这是运维专用的，最好运行在Linux系统上，有实战意义。</li>
</ul>
<p>检测安装成功:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1112615-deb275ca4824f5ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h1 id="0x01-配置"><a href="#0x01-配置" class="headerlink" title="0x01 配置"></a>0x01 配置</h1><p>安装之后是需要做一些配置，如果你是从源码<code>make install</code>安装的，可能没有配置文件。可以直接从example文件夹中，复制一份到<code>/etc/ansible/</code>下就可以了。</p>
<p>如果没有这个文件夹，创建一下就行，保证ansible的操作用户有这个文件夹的操作权限。</p>
<p>如果是其他方式安装的，执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br></pre></td></tr></table></figure></p>
<p>可以看到配置文件的位置，找不到就去github上看看，example文件夹里有<br>这两个文件，很重要！</p>
<ul>
<li>ansible.cfg：是ansible 全局的配置</li>
<li>hosts：是ansible管理的主机列表，和部分参数。</li>
</ul>
<p>anbile配置文件是有优先级的<br>下面是ansible1.5只后版本查找ansible.cfg的优先级。</p>
<ol>
<li>ANSIBLE_CONFIG (an environment variable)</li>
<li>ansible.cfg (in the current directory)</li>
<li>.ansible.cfg (in the home directory)</li>
<li>/etc/ansible/ansible.cfg</li>
</ol>
<p>下面是配置参数大全，参考用。<br>刚开始使用的时候，主要配置hosts文件位置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (扩展插件存放目录)</span></span><br><span class="line">action_plugins = /usr/share/ansible_plugins/action_plugins </span><br><span class="line"><span class="comment"># (插入Ansible模板的字符串)</span></span><br><span class="line">ansible_managed = Ansible managed: &#123;file&#125; modified on %Y-%m-%d %H:%M:%S by &#123;uid&#125; on &#123;host&#125;</span><br><span class="line"><span class="comment"># （PlayBook是否需要提供密码，默认为No）</span></span><br><span class="line"><span class="comment"># ask_pass=True</span></span><br><span class="line"><span class="comment"># （PlayBook是否需要提供sudo 密码）[](http://www.ansible.cn/docs/intro_configuration.html#ask-sudo-pass)</span></span><br><span class="line"><span class="comment"># ask_sudo_pass=True</span></span><br><span class="line"><span class="comment"># （回调函数插件存放路径）</span></span><br><span class="line">action_plugins = /usr/share/ansible_plugins/action_plugins</span><br><span class="line"><span class="comment"># （连接插件存放路径）</span></span><br><span class="line">action_plugins = /usr/share/ansible_plugins/action_plugins</span><br><span class="line"><span class="comment"># （是否展示警告信息）</span></span><br><span class="line">deprecation_warnings = True</span><br><span class="line"><span class="comment"># （是否展示跳过的主机的信息）</span></span><br><span class="line"><span class="comment"># display_skipped_hosts=True</span></span><br><span class="line"><span class="comment"># （执行错误时候赋予的变量）</span></span><br><span class="line"><span class="comment"># error_on_undefined_vars=True</span></span><br><span class="line"><span class="comment"># （默认的Shell）</span></span><br><span class="line"><span class="comment"># executable = /bin/bash</span></span><br><span class="line"><span class="comment"># （拦截器插件）</span></span><br><span class="line">action_plugins = /usr/share/ansible_plugins/action_plugins</span><br><span class="line"><span class="comment"># （最大进程数）</span></span><br><span class="line">forks=5</span><br><span class="line"><span class="comment"># （哈希特性，没事不用去动它）</span></span><br><span class="line"><span class="comment"># hash_behavior=replace</span></span><br><span class="line"><span class="comment"># （资产文件存放位置）</span></span><br><span class="line">hostfile = /etc/ansible/hosts</span><br><span class="line"><span class="comment"># （是否检查SSH key）</span></span><br><span class="line">host_key_checking=True</span><br><span class="line"><span class="comment"># （JinJa扩展）</span></span><br><span class="line">jinja2_extensions = jinja2.ext.do,jinja2.ext.i18n</span><br><span class="line"><span class="comment"># （PlayBook变量）</span></span><br><span class="line">legacy_playbook_variables = no</span><br><span class="line"><span class="comment"># （Ansible默认库）</span></span><br><span class="line">library = /usr/share/ansible</span><br><span class="line"><span class="comment"># （日志路径）</span></span><br><span class="line">log_path=/var/<span class="built_in">log</span>/ansible.log</span><br><span class="line"><span class="comment"># （插件路径）</span></span><br><span class="line">action_plugins = /usr/share/ansible_plugins/action_plugins</span><br><span class="line"><span class="comment"># （默认模块名称）</span></span><br><span class="line">module_name = <span class="built_in">command</span></span><br><span class="line"><span class="comment"># (输出样式)</span></span><br><span class="line">nocolor=0</span><br><span class="line"><span class="comment"># (是否使用cowsay打印)</span></span><br><span class="line">nocows=0</span><br><span class="line"><span class="comment"># （主机）</span></span><br><span class="line">hosts=*</span><br><span class="line"><span class="comment"># （pool间隔）</span></span><br><span class="line">poll_interval=15</span><br><span class="line"><span class="comment"># （私钥的存放路径）</span></span><br><span class="line">private_key_file=/path/to/file.pem</span><br><span class="line"><span class="comment"># （远程连接端口号）</span></span><br><span class="line">remote_port = 22</span><br><span class="line"><span class="comment"># (远程目录临时文件夹)</span></span><br><span class="line">remote_temp = <span class="variable">$HOME</span>/.ansible/tmp</span><br><span class="line"><span class="comment"># （远程用户）</span></span><br><span class="line">remote_user = root</span><br><span class="line"><span class="comment"># （角色路径）</span></span><br><span class="line">roles_path = /opt/mysite/roles</span><br><span class="line"><span class="comment"># （SUDO执行）</span></span><br><span class="line">sudo_exe=sudo</span><br><span class="line"><span class="comment"># （SUDO标记）</span></span><br><span class="line">sudo_flags=-H</span><br><span class="line"><span class="comment"># （sudo用户）</span></span><br><span class="line">sudo_user=root</span><br><span class="line"><span class="comment"># （重连次数）</span></span><br><span class="line">timeout = 10</span><br><span class="line"><span class="comment"># （传输模式） 默认用的smart</span></span><br><span class="line">transport</span><br><span class="line"><span class="comment"># （变量插件存放路径）</span></span><br><span class="line">action_plugins = /usr/share/ansible_plugins/action_plugins</span><br><span class="line"><span class="comment"># SSH变量</span></span><br><span class="line"><span class="comment"># (SSH连接参数)</span></span><br><span class="line">ssh_args = -o ControlMaster=auto -o ControlPersist=60s</span><br><span class="line"><span class="comment"># （采用SCP还是SFTP进行文件传输）</span></span><br><span class="line">scp_if_ssh=False</span><br></pre></td></tr></table></figure></p>
<h1 id="0x02-host文件"><a href="#0x02-host文件" class="headerlink" title="0x02 host文件"></a>0x02 host文件</h1><p>hosts文件是ansible管理主机的Inventory文件，里面存放的是主机组和部分参数<br>例如<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">127.0.0.2 ansible_ssh_port=22 ansible_user=zing ansible_ssh_pass=别傻了，我不会写的</span><br><span class="line"></span><br><span class="line">[webserver]</span><br><span class="line">xxx1.example.com ansible_ssh_port=33 ansible_user=root</span><br><span class="line">xxx2.example.com</span><br></pre></td></tr></table></figure></p>
<p>port：ssh到目标主机的端口<br>user：目标主机将会以这个身份登录<br>pass：目标主机该用户的密码</p>
<p>中括号内是主机的分组名</p>
<ul>
<li>下面的是主机地址，可以是ip，可以是域名。ip（域名）之后跟的是链接参数。</li>
<li>如果啥都不写，安装咱们之前写的ansible.cfg中定义的默认配置来进行ssh链接</li>
<li>其中如果两台主机进行了ssh 互信。那么ansible_ssh_pass参数可以不写。<br><a href="http://ansible-tran.readthedocs.io/en/latest/docs/intro_inventory.html" target="_blank" rel="noopener">http://ansible-tran.readthedocs.io/en/latest/docs/intro_inventory.html</a><br>在上面有详细讲解hosts文件定义的规范和技巧。</li>
</ul>
<p>遇到几个坑：</p>
<p>错误：用户没有ssh的权限。首先保证user能被ssh连上。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to connect to the host via ssh: Permission denied</span><br></pre></td></tr></table></figure></p>
<p>错误：密码不对<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authentication failure.</span><br></pre></td></tr></table></figure></p>
<p>错误：主机没有sshpass模块，这个想办法自己装上。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">to use the <span class="string">'ssh'</span> connection <span class="built_in">type</span> with passwords, you must install the sshpass program</span><br></pre></td></tr></table></figure></p>
<h1 id="0x03-爱因斯坦的小板凳-hello-world"><a href="#0x03-爱因斯坦的小板凳-hello-world" class="headerlink" title="0x03 爱因斯坦的小板凳 hello world"></a>0x03 爱因斯坦的小板凳 hello world</h1><p>接下来介绍使用ansible在目标主机上打印出：hello world<br>先不管命令的含义<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 127.0.0.1 -m <span class="built_in">command</span> -a <span class="string">'echo "hello world"'</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1112615-168b6a19d6b502f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="成功！"></p>
<h1 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h1><ul>
<li><a href="http://ansible-tran.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">http://ansible-tran.readthedocs.io/en/latest/index.html</a></li>
<li><a href="http://docs.ansible.com/ansible/" target="_blank" rel="noopener">http://docs.ansible.com/ansible/</a></li>
<li><a href="http://docs.ansible.com/ansible/intro_configuration.html" target="_blank" rel="noopener">http://docs.ansible.com/ansible/intro_configuration.html</a></li>
<li>已失效：<a href="http://www.kiratechblog.com/?p=420" target="_blank" rel="noopener">http://www.kiratechblog.com/?p=420</a></li>
</ul>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title="0" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                        
                            <li title="1" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                </ul>
            
        </div>
        
    <div id="gitalk-container" class="comment link" data-enable="false" data-ae="false" data-ci="" data-cs="" data-r="" data-o="" data-a="" data-d="false">查看评论</div>


    </div>
    
        <div class="side">
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-安装"><span class="toc-number">1.</span> <span class="toc-text">0x00 安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-配置"><span class="toc-number">2.</span> <span class="toc-text">0x01 配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-host文件"><span class="toc-number">3.</span> <span class="toc-text">0x02 host文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-爱因斯坦的小板凳-hello-world"><span class="toc-number">4.</span> <span class="toc-text">0x03 爱因斯坦的小板凳 hello world</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-参考"><span class="toc-number">5.</span> <span class="toc-text">0x04 参考</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
</body>

<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>






</html>
